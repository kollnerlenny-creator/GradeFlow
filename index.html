import React, { useState, useEffect, useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, LineChart, Line, CartesianGrid } from 'recharts';
import { Home, LayoutGrid, TrendingUp, Plus, ArrowLeft, Settings, X, GraduationCap, ChevronRight, Zap, Percent, Sliders, RefreshCw } from 'lucide-react';

// --- SheetsDB Konfiguration ---
// Ersetze 'DEINE_API_ID' mit deiner echten ID von sheetsdb.io
const SHEETSDB_API_ID = 'lu9rn3kh5hok9'; 
const API_URL = `https://sheetsdb.io/api/v1/${SHEETSDB_API_ID}`;

const HALF_YEARS = ['11/1', '11/2', '12/1', '12/2'];
const SUBJECT_COLORS = ['#6366f1', '#f87171', '#fb923c', '#facc15', '#4ade80', '#2dd4bf', '#38bdf8', '#60a5fa', '#a78bfa', '#f472b6'];
const GRADE_TYPES = { EXAM: 'Klausur', OTHER: 'Sonstige Leistung' };

const pointsToGrade = (p) => p !== null ? (17 - p) / 3 : null;

// --- UI Komponenten ---
const AppleToggle = ({ enabled, setEnabled }) => (
  <button onClick={() => setEnabled(!enabled)} className={`${enabled ? 'bg-green-500' : 'bg-gray-600'} relative inline-flex h-7 w-12 items-center rounded-full transition-all shadow-inner`}>
    <span className={`${enabled ? 'translate-x-6' : 'translate-x-1'} inline-block h-5 w-5 transform rounded-full bg-white transition-transform shadow-md`} />
  </button>
);

const AppleGlassCard = ({ children, className = '', onClick = null, style = {} }) => (
  <div style={style} className={`bg-[#1c1c1e]/60 backdrop-blur-3xl border border-white/10 rounded-[2.5rem] p-7 shadow-xl transition-all duration-500 ${onClick ? 'cursor-pointer hover:bg-[#2c2c2e]/80 active:scale-[0.98]' : ''} ${className}`} onClick={onClick}>
    {children}
  </div>
);

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-end md:items-center justify-center p-0 md:p-6 bg-black/80 backdrop-blur-xl animate-in fade-in">
      <div className="bg-[#121214] border-t md:border border-white/10 w-full max-w-lg rounded-t-[3.5rem] md:rounded-[3.5rem] p-10 shadow-2xl max-h-[92vh] overflow-y-auto no-scrollbar">
        <div className="flex justify-between items-center mb-8 sticky top-0 bg-[#121214] z-10 pb-2">
          <h2 className="text-3xl font-extrabold text-white">{title}</h2>
          <button onClick={onClose} className="p-3 bg-white/5 rounded-full text-white/40"><X size={24}/></button>
        </div>
        {children}
      </div>
    </div>
  );
};

const App = () => {
  const [subjects, setSubjects] = useState([]);
  const [loading, setLoading] = useState(false);
  const [currentTab, setCurrentTab] = useState('home'); 
  const [selectedHalfYear, setSelectedHalfYear] = useState('11/1');
  const [selectedSubject, setSelectedSubject] = useState(null);
  
  const [isSubjectModalOpen, setIsSubjectModalOpen] = useState(false);
  const [isGradeModalOpen, setIsGradeModalOpen] = useState(false);
  const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
  
  const [gradeForm, setGradeForm] = useState({ id: null, points: 10, type: GRADE_TYPES.EXAM, note: '', date: new Date().toISOString().split('T')[0] });
  const [subjectForm, setSubjectForm] = useState({ name: '', isLK: false, color: SUBJECT_COLORS[0], examWeight: 50 });

  // Daten von SheetsDB laden
  const fetchSubjects = async () => {
    if (!SHEETSDB_API_ID) return;
    setLoading(true);
    try {
      const response = await fetch(API_URL);
      const data = await response.json();
      // Wir wandeln den String aus der "grades" Spalte zurück in ein Array
      const formattedData = data.map(item => ({
        ...item,
        isLK: item.isLK === "true" || item.isLK === true,
        examWeight: parseInt(item.examWeight) || 50,
        grades: item.grades ? JSON.parse(item.grades) : []
      }));
      setSubjects(formattedData);
    } catch (e) {
      console.error("Fehler beim Laden von SheetsDB", e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchSubjects();
  }, []);

  const processedData = useMemo(() => {
    const semesterSubjects = subjects.map(s => {
      const grades = (s.grades || []).filter(g => g.semester === selectedHalfYear);
      const exams = grades.filter(g => g.type === GRADE_TYPES.EXAM);
      const others = grades.filter(g => g.type === GRADE_TYPES.OTHER);
      
      const avgExams = exams.length ? exams.reduce((a, b) => a + b.points, 0) / exams.length : null;
      const avgOthers = others.length ? others.reduce((a, b) => a + b.points, 0) / others.length : null;
      
      const weightE = (s.examWeight || 50) / 100;
      const weightO = 1 - weightE;

      let final = null;
      if (avgExams !== null && avgOthers !== null) final = (avgExams * weightE) + (avgOthers * weightO);
      else if (avgExams !== null) final = avgExams;
      else if (avgOthers !== null) final = avgOthers;

      return { 
        ...s, 
        semesterGrades: grades, 
        finalPoints: final, 
        finalGrade: pointsToGrade(final),
        weight: s.isLK ? 2 : 1,
        trendData: [...grades].sort((a, b) => new Date(a.date) - new Date(b.date)).map(g => ({
          date: new Date(g.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
          points: g.points
        }))
      };
    });

    const active = semesterSubjects.filter(s => s.finalPoints !== null);
    const sumP = active.reduce((a, b) => a + (b.finalPoints * b.weight), 0);
    const sumW = active.reduce((a, b) => a + b.weight, 0);
    const avgPoints = sumW > 0 ? sumP / sumW : 0;
    const avgGrade = sumW > 0 ? pointsToGrade(avgPoints) : null;

    const pointsDistribution = Array.from({ length: 16 }, (_, i) => ({ points: i, count: 0 }));
    semesterSubjects.forEach(s => {
      s.semesterGrades.forEach(g => {
        if (g.points >= 0 && g.points <= 15) pointsDistribution[g.points].count++;
      });
    });

    return { semesterSubjects, avgPoints, avgGrade, pointsDistribution };
  }, [subjects, selectedHalfYear]);

  const handleSaveSubject = async () => {
    if (!SHEETSDB_API_ID || !subjectForm.name) return;
    const newId = crypto.randomUUID();
    const payload = {
      id: newId,
      ...subjectForm,
      grades: JSON.stringify([]) // Als String für Sheets speichern
    };

    try {
      await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: [payload] })
      });
      setIsSubjectModalOpen(false);
      fetchSubjects();
    } catch (e) { console.error(e); }
  };

  const handleSaveGrade = async () => {
    if (!selectedSubject) return;
    const newGrade = { ...gradeForm, id: gradeForm.id || crypto.randomUUID(), semester: selectedHalfYear };
    const updatedGrades = gradeForm.id 
        ? selectedSubject.grades.map(g => g.id === gradeForm.id ? newGrade : g)
        : [...selectedSubject.grades, newGrade];

    try {
      // SheetsDB Update: Wir suchen per ID und patchen die "grades" Spalte
      await fetch(`${API_URL}/id/${selectedSubject.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: { grades: JSON.stringify(updatedGrades) } })
      });
      setIsGradeModalOpen(false);
      fetchSubjects();
      // Update lokales State für flüssiges UI
      const updatedSubject = {...selectedSubject, grades: updatedGrades};
      setSelectedSubject(updatedSubject);
    } catch (e) { console.error(e); }
  };

  const handleDeleteSubject = async () => {
    if (!selectedSubject) return;
    try {
      await fetch(`${API_URL}/id/${selectedSubject.id}`, { method: 'DELETE' });
      setSelectedSubject(null);
      setIsSettingsModalOpen(false);
      fetchSubjects();
    } catch (e) { console.error(e); }
  };

  const activeSubjectData = processedData.semesterSubjects.find(s => s.id === selectedSubject?.id);

  return (
    <div className="min-h-screen bg-[#09090b] text-white font-sans pb-32">
      <div className="max-w-7xl mx-auto px-6 pt-12">
        
        <header className="mb-14 space-y-10">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-5">
              <div className="bg-indigo-600 p-4 rounded-[1.75rem]">
                <GraduationCap size={28} />
              </div>
              <h1 className="text-3xl font-black">GradeFlow <span className="text-xs text-white/20 font-normal">SheetsDB Edition</span></h1>
            </div>
            <button onClick={fetchSubjects} className={`p-3 rounded-full bg-white/5 ${loading ? 'animate-spin' : ''}`}>
                <RefreshCw size={20} />
            </button>
          </div>

          <div className="max-w-md mx-auto bg-[#1c1c1e] p-1.5 rounded-[2rem] flex ring-1 ring-white/10 relative">
            <div className="absolute top-1.5 bottom-1.5 bg-white rounded-[1.65rem] transition-all duration-300" style={{ width: `calc(100% / 4 - 3px)`, left: `calc(${HALF_YEARS.indexOf(selectedHalfYear)} * 100% / 4 + 1.5px)` }} />
            {HALF_YEARS.map(s => (
                <button key={s} onClick={() => setSelectedHalfYear(s)} className={`flex-1 py-3 text-[11px] font-black relative z-10 ${selectedHalfYear === s ? 'text-black' : 'text-white/30'}`}>{s}</button>
            ))}
          </div>
        </header>

        {!SHEETSDB_API_ID && (
            <div className="bg-yellow-500/10 border border-yellow-500/20 p-6 rounded-2xl mb-8 text-yellow-200 text-sm">
                Hinweis: Bitte trage deine <b>SHEETSDB_API_ID</b> im Code ein, um die Datenbank zu verbinden.
            </div>
        )}

        <main>
          {selectedSubject ? (
            <div className="space-y-8">
              <button onClick={() => setSelectedSubject(null)} className="flex items-center space-x-2 text-white/40 hover:text-white bg-white/5 px-6 py-3 rounded-full">
                <ArrowLeft size={16} /> <span>Zurück</span>
              </button>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div className="lg:col-span-2">
                  <AppleGlassCard style={{ borderLeft: `12px solid ${selectedSubject.color}` }}>
                    <div className="flex justify-between">
                      <h2 className="text-4xl font-black">{selectedSubject.name}</h2>
                      <button onClick={() => setIsSettingsModalOpen(true)} className="p-4 bg-white/5 rounded-2xl"><Settings size={22}/></button>
                    </div>
                    <div className="mt-8 flex gap-3">
                        <span className="text-[10px] font-black uppercase bg-white/5 px-3 py-1 rounded-full">{selectedSubject.isLK ? 'Leistungskurs' : 'Grundkurs'}</span>
                        <span className="text-[10px] font-black uppercase bg-white/5 px-3 py-1 rounded-full">{selectedSubject.examWeight}% Klausur</span>
                    </div>
                  </AppleGlassCard>
                </div>
                
                <div className="space-y-4">
                    <p className="text-[10px] font-black uppercase text-white/20">Notenliste</p>
                    {activeSubjectData?.semesterGrades.map(g => (
                        <div key={g.id} className="bg-white/5 p-4 rounded-2xl flex justify-between items-center">
                            <span className="text-2xl font-black">{g.points}</span>
                            <span className="text-xs text-white/40">{g.type}</span>
                        </div>
                    ))}
                    <button onClick={() => setIsGradeModalOpen(true)} className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-white/20 hover:text-white transition-all">+ Note</button>
                </div>
              </div>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {processedData.semesterSubjects.map(s => (
                <AppleGlassCard key={s.id} onClick={() => setSelectedSubject(s)} style={{ borderTop: `4px solid ${s.color}` }}>
                  <div className="flex justify-between items-start">
                    <h3 className="text-2xl font-black">{s.name}</h3>
                    <span className="text-3xl font-black" style={{ color: s.color }}>{s.finalPoints?.toFixed(0) || '-'}</span>
                  </div>
                  <p className="text-[10px] text-white/30 mt-2">{s.isLK ? 'LK' : 'GK'} • {s.semesterGrades.length} Noten</p>
                </AppleGlassCard>
              ))}
              <button onClick={() => setIsSubjectModalOpen(true)} className="h-40 border-2 border-dashed border-white/10 rounded-[2.5rem] flex flex-col items-center justify-center text-white/20 hover:bg-white/5 transition-all">
                <Plus size={32} />
              </button>
            </div>
          )}
        </main>

        {/* Modale (vereinfacht für das Beispiel) */}
        <Modal isOpen={isSubjectModalOpen} onClose={() => setIsSubjectModalOpen(false)} title="Neues Fach">
          <div className="space-y-6">
            <input className="w-full bg-white/5 border border-white/10 rounded-2xl p-4" placeholder="Fachname" value={subjectForm.name} onChange={e => setSubjectForm({...subjectForm, name: e.target.value})} />
            <div className="flex items-center justify-between p-4 bg-white/5 rounded-2xl">
                <span>Leistungskurs?</span>
                <AppleToggle enabled={subjectForm.isLK} setEnabled={v => setSubjectForm({...subjectForm, isLK: v})} />
            </div>
            <button onClick={handleSaveSubject} className="w-full bg-indigo-600 py-4 rounded-2xl font-black">SPEICHERN</button>
          </div>
        </Modal>

        <Modal isOpen={isGradeModalOpen} onClose={() => setIsGradeModalOpen(false)} title="Note eintragen">
            <div className="space-y-6">
                <div className="text-center text-6xl font-black mb-4">{gradeForm.points}</div>
                <input type="range" min="0" max="15" value={gradeForm.points} onChange={e => setGradeForm({...gradeForm, points: parseInt(e.target.value)})} className="w-full" />
                <button onClick={handleSaveGrade} className="w-full bg-indigo-600 py-4 rounded-2xl font-black">OK</button>
            </div>
        </Modal>

      </div>
    </div>
  );
};

export default App;
